#!/usr/bin/env bash
set -euo pipefail

# Install Nix (single-user mode) and home-manager on Arch Linux
# This script only sets up the config management tooling,
# not the actual packages (use pacman/yay for that).

echo "==> Installing Nix (single-user)..."
if ! command -v nix &>/dev/null; then
  sh <(curl -L https://nixos.org/nix/install) --no-daemon
  . "$HOME/.nix-profile/etc/profile.d/nix.sh"
else
  echo "    Nix already installed, skipping."
fi

echo "==> Enabling flakes..."
mkdir -p "$HOME/.config/nix"
if ! grep -q "experimental-features" "$HOME/.config/nix/nix.conf" 2>/dev/null; then
  echo "experimental-features = nix-command flakes" >> "$HOME/.config/nix/nix.conf"
fi

echo "==> Installing home-manager..."
if ! command -v home-manager &>/dev/null; then
  nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
  nix-channel --update
  nix-shell '<home-manager>' -A install
else
  echo "    home-manager already installed, skipping."
fi

echo "==> Done! Run 'apps/arch/apply' to apply your configuration."
